<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOX | Professional Language Learning</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#29D1F1',
                        'primary-hover': '#1bbcd9',
                        'vox-dark': '#0D1117',
                        secondary: '#64748b',
                        success: '#10b981',
                        error: '#ef4444',
                        'bg-color': '#f8fafc',
                        'card-bg': '#ffffff',
                    },
                    fontFamily: {
                        main: ['Inter', 'sans-serif'],
                        brand: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'vox-lg': '0 10px 15px -3px rgb(0 0 0 / 0.1)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
            animation: spin 0.8s linear infinite;
        }
        .perspective-1000 {
            perspective: 1000px;
        }
        .transform-style-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
        /* Fade in animation for overlays */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        /* Pop in animation */
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body class="bg-bg-color text-vox-dark font-main pb-20">
    <div id="root"></div>

    <script>
        /**
         * ------------------------------------------------------------------
         * SERVICES
         * ------------------------------------------------------------------
         */
        const GITHUB_BASE = 'https://raw.githubusercontent.com/MegaExplore/vox.github.io/main/schemas/';
        const STORAGE_KEY = 'vox_user_progress';

        const defaultState = {
            siteLanguage: 'en',
            targetLanguage: 'all',
            level: 'A1',
            unlockedStages: {}
        };

        async function fetchData(path) {
            const url = path.startsWith('http') ? path : `${GITHUB_BASE}${path}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Fetch failed`);
            return await response.json();
        }

        function initSession() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? { ...defaultState, ...JSON.parse(stored) } : { ...defaultState };
            } catch (e) {
                return { ...defaultState };
            }
        }

        function saveProgress(state) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function unlockStage(state, lang, level, section, stage) {
            const newState = { ...state };
            if (!newState.unlockedStages[lang]) newState.unlockedStages[lang] = {};
            if (!newState.unlockedStages[lang][level]) newState.unlockedStages[lang][level] = {};
            if (!newState.unlockedStages[lang][level][section]) newState.unlockedStages[lang][level][section] = [];
            
            if (!newState.unlockedStages[lang][level][section].includes(stage)) {
                newState.unlockedStages[lang][level][section].push(stage);
            }
            saveProgress(newState);
            return newState;
        }

        function speakText(text, lang = 'en-US') {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        function startListening(lang = 'en-US') {
            return new Promise((resolve, reject) => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return reject('Not supported');
                
                const rec = new SpeechRecognition();
                rec.lang = lang;
                rec.continuous = false; // Fix for mobile
                rec.interimResults = true;
                rec.maxAlternatives = 1;

                console.log(`Starting speech recognition for lang: ${lang}`);

                let resolved = false;
                let soundDetected = false;
                let safetyTimer = null;

                rec.onsoundstart = () => {
                    soundDetected = true;
                    console.log('Sound detected');
                };

                rec.onresult = (e) => {
                    const results = e.results;
                    for (let i = e.resultIndex; i < results.length; ++i) {
                        if (results[i].isFinal) {
                            console.log('Final result:', results[i][0].transcript);
                            resolved = true;
                            resolve(results[i][0].transcript);
                            rec.stop();
                            if (safetyTimer) clearTimeout(safetyTimer);
                            return;
                        }
                    }
                };

                rec.onerror = (e) => {
                    console.error('Speech error:', e.error);
                    resolved = true;
                    reject(e.error);
                };

                rec.onnomatch = () => {
                    resolved = true;
                    reject('No match');
                };

                rec.onend = () => {
                    if (safetyTimer) clearTimeout(safetyTimer);
                    if (!resolved) {
                        if (soundDetected) reject('No sensitivity/match: Sound detected but no text recognized.');
                        else reject('No sound detected');
                    }
                };

                try {
                    rec.start();
                    safetyTimer = setTimeout(() => {
                        rec.stop();
                    }, 8000); // Increased timeout to 8s
                } catch (e) {
                    reject(e);
                }
            });
        }

        /**
         * ------------------------------------------------------------------
         * UI UTILITIES
         * ------------------------------------------------------------------
         */
        function el(tag, props = {}, children = []) {
            const element = document.createElement(tag);
            if (props.className) element.className = props.className;
            
            Object.entries(props).forEach(([key, value]) => {
                if (key === 'className') return;
                if (key.startsWith('on') && typeof value === 'function') {
                    element.addEventListener(key.toLowerCase().substring(2), value);
                } else if (key === 'innerHTML') {
                    element.innerHTML = value;
                } else if (key === 'style' && typeof value === 'object') {
                    Object.assign(element.style, value);
                } else if (key === 'selected' && value) {
                    element.selected = true;
                } else if (key === 'disabled' && value) {
                    element.disabled = true;
                } else if (key === 'value') {
                    element.value = value;
                } else {
                    element.setAttribute(key, value);
                }
            });

            children.forEach(child => {
                if (child === null || child === undefined) return;
                if (typeof child === 'string' || typeof child === 'number') {
                    element.appendChild(document.createTextNode(child));
                } else if (child instanceof Node) {
                    element.appendChild(child);
                }
            });
            return element;
        }

        /**
         * ------------------------------------------------------------------
         * COMPONENTS
         * ------------------------------------------------------------------
         */

        // --- Header Component ---
        function createHeader(userState, onStateChange, onLogoClick) {
            const logoSvg = `<svg class="h-full w-auto max-w-[320px]" viewBox="0 0 750 150" xmlns="http://www.w3.org/2000/svg">
                <text x="20" y="100" fill="#0D1117" style="font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 80px">Vox</text>
                <text x="210" y="100" fill="#29D1F1" style="font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 80px">MegaLiberta</text>
            </svg>`;

            const createSelect = (label, key, options) => {
                const select = el('select', {
                    className: "px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm font-medium text-vox-dark cursor-pointer outline-none transition-colors hover:border-primary",
                    onChange: (e) => onStateChange(key, e.target.value)
                }, options.map(opt => {
                    const option = el('option', { value: opt.value }, [opt.label]);
                    if (userState[key] === opt.value) option.selected = true;
                    return option;
                }));
                
                return el('div', { className: "flex flex-col" }, [
                    el('label', { className: "text-[0.65rem] uppercase font-bold text-secondary mb-[2px] ml-[2px]" }, [label]),
                    select
                ]);
            };

            const logoContainer = el('div', { 
                className: "h-12 flex items-center cursor-pointer transition-transform hover:scale-102",
                innerHTML: logoSvg,
                onClick: onLogoClick
            });

            const controls = el('div', { className: "flex gap-3 items-center w-full md:w-auto justify-center md:justify-end flex-wrap" }, [
                createSelect('Site', 'siteLanguage', [{value:'en',label:'English'}, {value:'es',label:'EspaÃ±ol'}, {value:'fr',label:'FranÃ§ais'}]),
                createSelect('Learning', 'targetLanguage', [{value:'all',label:'All Modules'}, {value:'en',label:'English'}, {value:'es',label:'Spanish'}]),
                createSelect('Your Level', 'level', ['A1','A2','B1','B2','C1','C2'].map(l => ({value:l, label:l})))
            ]);

            return el('header', { className: "sticky top-0 w-full bg-white/90 backdrop-blur-md border-b border-gray-200 z-[1000] py-2" }, [
                el('div', { className: "max-w-[1200px] mx-auto px-6 flex justify-between items-center gap-5 flex-wrap md:flex-nowrap" }, [
                    logoContainer,
                    controls
                ])
            ]);
        }

        // --- Stage Menu Component ---
        function createStageMenu(manifest, userState, onSelectStage) {
            if (!manifest) {
                return el('div', { className: "text-center py-24" }, [
                    el('div', { className: "w-8 h-8 mx-auto mb-6 border-4 border-gray-200 border-t-primary rounded-full animate-spin-custom" }),
                    el('h2', { className: "text-secondary text-xl font-semibold" }, ["Initializing VOX..."])
                ]);
            }

            const langData = manifest.languages['all'];
            const selectedLevel = userState.level;
            const levelData = langData.levels[selectedLevel];

            if (!levelData || !levelData.sections || levelData.sections.length === 0) {
                return el('div', { className: "text-center py-16 text-secondary" }, [
                    el('div', { className: "text-5xl mb-4" }, ["â³"]),
                    el('p', {}, [`Level ${selectedLevel} content is currently being prepared.`])
                ]);
            }

            const isStageAccessible = (lang, level, section, stageId, manifestStage) => {
                if (manifestStage.isFree) return true;
                if (stageId === 1) return true;
                const unlocked = userState.unlockedStages[lang]?.[level]?.[section] || [];
                return unlocked.includes(stageId - 1);
            };

            const container = el('div', {});

            levelData.sections.forEach(sec => {
                const secKey = sec.title.replace(/\s+/g, '_');
                const title = el('h3', { className: "mt-8 mb-5 text-primary font-extrabold text-2xl" }, [sec.title]);
                
                const grid = el('div', { className: "grid grid-cols-[repeat(auto-fill,minmax(160px,1fr))] md:grid-cols-[repeat(auto-fill,minmax(220px,1fr))] gap-6 mt-6" });

                sec.stages.forEach(stg => {
                    const ok = isStageAccessible('all', selectedLevel, secKey, stg.id, stg);
                    
                    const btnClass = `flex flex-col items-center p-8 md:p-6 bg-white border-2 border-gray-200 rounded-xl transition-all duration-200 text-center ${
                        ok ? 'cursor-pointer hover:border-primary hover:-translate-y-1 hover:shadow-md' : 'opacity-50 bg-slate-50 cursor-not-allowed grayscale'
                    }`;

                    const btn = el('button', { 
                        className: btnClass,
                        disabled: !ok,
                        onClick: () => ok && onSelectStage(stg.cid, selectedLevel, secKey, stg.id)
                    }, [
                        el('div', { className: "text-4xl mb-3" }, [ok ? (stg.icon || 'ðŸ“–') : 'ðŸ”’']),
                        el('div', { className: "font-bold text-vox-dark" }, [stg.name])
                    ]);

                    grid.appendChild(btn);
                });

                container.appendChild(title);
                container.appendChild(grid);
            });

            return container;
        }

        // --- Feedback Overlay ---
        function showFeedbackOverlay(isCorrect, callback) {
            const icon = isCorrect ? 'âœ…' : 'âŒ';
            const title = isCorrect ? 'Precision' : 'Try Again';
            const colorClass = isCorrect ? 'text-success' : 'text-error';

            const overlay = el('div', { className: "fixed inset-0 bg-vox-dark/40 backdrop-blur-sm flex justify-center items-center z-[2000] animate-fade-in" }, [
                el('div', { className: "bg-white p-12 rounded-[32px] text-center shadow-vox-lg animate-pop-in" }, [
                    el('span', { className: "text-[5rem] block mb-4" }, [icon]),
                    el('h2', { className: `text-3xl font-brand font-bold ${colorClass}` }, [title])
                ])
            ]);

            document.body.appendChild(overlay);

            setTimeout(() => {
                overlay.remove();
                if (callback) callback();
            }, 1000);
        }

        // --- Translation Modal ---
        function createTranslationModal(isOpen, exId, siteLang, onClose) {
            const modalContainer = el('div', { 
                className: `fixed bottom-0 left-1/2 -translate-x-1/2 w-[95%] max-w-[550px] bg-white p-8 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.15)] transition-all duration-400 z-[3000] transform ${isOpen ? 'translate-y-0' : 'translate-y-full'}`,
            });
            
            const header = el('div', { className: "flex justify-between items-center mb-5" }, [
                el('h3', { className: "m-0 text-lg text-secondary uppercase font-semibold" }, ["Linguistic Insight"]),
                el('button', { 
                    className: "bg-transparent border-none text-2xl cursor-pointer text-secondary hover:text-vox-dark",
                    onClick: onClose
                }, ["âœ•"])
            ]);

            const contentDiv = el('div', { className: "min-h-[100px]" });

            if (isOpen && exId) {
                contentDiv.appendChild(el('div', { className: "flex justify-center py-6" }, [
                    el('div', { className: "w-8 h-8 border-4 border-gray-200 border-t-primary rounded-full animate-spin-custom" })
                ]));
                
                fetchData('secondary.json')
                    .then(data => {
                        const entry = data[exId];
                        let val = "No context available.";
                        if (entry) {
                            if (typeof entry === 'string') val = entry;
                            else if (typeof entry === 'object') val = entry[siteLang] || entry['en'] || "No context available.";
                        }
                        contentDiv.innerHTML = '';
                        contentDiv.appendChild(el('p', { className: "text-xl leading-relaxed font-medium text-vox-dark" }, [`"${val}"`]));
                    })
                    .catch(() => {
                        contentDiv.innerHTML = '';
                        contentDiv.appendChild(el('p', { className: "text-xl leading-relaxed font-medium text-vox-dark" }, ["Analysis unavailable."]));
                    });
            }

            modalContainer.appendChild(header);
            modalContainer.appendChild(contentDiv);
            
            return modalContainer;
        }

        // --- EXERCISE RENDERERS ---

        const ExerciseRenderers = {
            multiple_choice: (exercise, onAnswer) => {
                const container = el('div', {});
                container.appendChild(el('h3', { className: "text-xl font-semibold mb-6 text-vox-dark" }, [exercise.question]));
                
                exercise.options?.forEach((opt) => {
                    const btn = el('button', { 
                        className: "block w-full text-left p-4 my-3 border border-gray-200 rounded-xl bg-white text-base font-semibold text-vox-dark hover:border-primary hover:bg-cyan-50 hover:text-primary-hover transition-all",
                        onClick: () => onAnswer(opt)
                    }, [opt]);
                    container.appendChild(btn);
                });
                return container;
            },

            matching: (exercise, onAnswer, showFeedback) => {
                const container = el('div', {});
                container.appendChild(el('h3', { className: "text-xl font-semibold mb-6 text-vox-dark" }, ["Match the Pairs:"]));

                let leftSide = [], rightSide = [];
                if (exercise.pairs) {
                    leftSide = [...exercise.pairs.map(p => p.left)].sort(() => Math.random() - 0.5);
                    rightSide = [...exercise.pairs.map(p => p.right)].sort(() => Math.random() - 0.5);
                }

                let selectedLeft = null;
                const matchedPairs = new Set();
                const leftBtns = [];
                const rightBtns = [];

                const updateUI = (errorRightText = null) => {
                    leftBtns.forEach(btn => {
                        const text = btn.textContent;
                        const isMatched = matchedPairs.has(text);
                        const isSelected = selectedLeft === text;
                        btn.disabled = isMatched;
                        btn.className = `option-btn w-full p-4 border rounded-xl font-semibold text-left transition-all ${
                            isMatched ? 'bg-success text-white border-success' : 
                            isSelected ? 'border-primary bg-white text-vox-dark' : 
                            'border-gray-200 bg-white text-vox-dark hover:bg-cyan-50'
                        }`;
                    });

                    rightBtns.forEach(btn => {
                        const text = btn.textContent;
                        const pair = exercise.pairs?.find(p => p.right === text);
                        const isMatched = pair && matchedPairs.has(pair.left);
                        const isError = errorRightText === text;
                        btn.disabled = !!isMatched;
                        btn.className = `option-btn w-full p-4 border rounded-xl font-semibold text-left transition-all ${
                            isMatched ? 'bg-success text-white border-success' : 
                            isError ? 'bg-error text-white border-error' : 
                            'border-gray-200 bg-white text-vox-dark hover:bg-cyan-50'
                        }`;
                    });
                };

                const grid = el('div', { className: "grid grid-cols-2 gap-4" });
                const leftCol = el('div', { className: "flex flex-col gap-3" });
                const rightCol = el('div', { className: "flex flex-col gap-3" });

                leftSide.forEach(text => {
                    const btn = el('button', {
                        onClick: () => {
                            if (matchedPairs.has(text)) return;
                            selectedLeft = text;
                            updateUI();
                        }
                    }, [text]);
                    leftBtns.push(btn);
                    leftCol.appendChild(btn);
                });

                rightSide.forEach(text => {
                    const btn = el('button', {
                        onClick: () => {
                            if (!selectedLeft) return;
                            const pair = exercise.pairs?.find(p => p.left === selectedLeft);
                            const isMatch = pair && pair.right === text;

                            if (isMatch) {
                                matchedPairs.add(selectedLeft);
                                const finished = matchedPairs.size === exercise.pairs.length;
                                selectedLeft = null;
                                updateUI();
                                if (finished) {
                                    setTimeout(() => onAnswer(text), 600);
                                }
                            } else {
                                updateUI(text); // show error
                                setTimeout(() => {
                                    showFeedback(false, () => {
                                        selectedLeft = null;
                                        updateUI();
                                    });
                                }, 400);
                            }
                        }
                    }, [text]);
                    rightBtns.push(btn);
                    rightCol.appendChild(btn);
                });
                
                updateUI();
                grid.appendChild(leftCol);
                grid.appendChild(rightCol);
                container.appendChild(grid);
                return container;
            },

            sentence_ordering: (exercise, onAnswer) => {
                const container = el('div', {});
                
                const header = el('div', { className: "flex items-center justify-between mb-6" }, [
                    el('h3', { className: "text-xl font-semibold m-0 text-vox-dark" }, ["Arrange in order:"]),
                    el('button', {
                        className: "bg-vox-dark text-white rounded-full w-11 h-11 flex items-center justify-center shadow-md hover:scale-110 hover:bg-primary transition-all",
                        onClick: () => speakText(exercise.answer || '', exercise.voiceLang || 'en-US'),
                        innerHTML: `<svg class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`
                    })
                ]);

                container.appendChild(header);

                let currentSentence = [];
                let shuffledWords = [...(exercise.words || [])].sort(() => Math.random() - 0.5);
                let hiddenIndices = new Set();

                const sentenceContainer = el('div', { className: "min-h-[80px] border-b-2 border-primary mb-5 flex gap-2 flex-wrap p-3 items-center" });
                const poolContainer = el('div', { className: "flex gap-2 flex-wrap" });

                const renderState = () => {
                    sentenceContainer.innerHTML = '';
                    poolContainer.innerHTML = '';

                    // Sentence Area
                    currentSentence.forEach((word, idx) => {
                        const wordEl = el('div', {
                            className: "bg-primary text-white px-4 py-2 rounded-lg font-semibold cursor-pointer hover:scale-105 hover:bg-primary-hover transition-all select-none",
                            onClick: () => {
                                // Remove from sentence
                                const wordToRemove = currentSentence[idx];
                                currentSentence.splice(idx, 1);
                                // Find first hidden index for this word to show it again
                                for (let i = 0; i < shuffledWords.length; i++) {
                                    if (shuffledWords[i] === wordToRemove && hiddenIndices.has(i)) {
                                        hiddenIndices.delete(i);
                                        break;
                                    }
                                }
                                renderState();
                            }
                        }, [word]);
                        sentenceContainer.appendChild(wordEl);
                    });

                    // Pool Area
                    shuffledWords.forEach((word, idx) => {
                        const wordBtn = el('button', {
                            className: `px-5 py-4 border border-gray-200 rounded-xl bg-white font-semibold text-vox-dark hover:border-primary hover:bg-cyan-50 hover:text-primary-hover transition-all ${hiddenIndices.has(idx) ? 'invisible' : 'visible'}`,
                            onClick: () => {
                                if (hiddenIndices.has(idx)) return;
                                currentSentence.push(word);
                                hiddenIndices.add(idx);
                                renderState();
                                if (currentSentence.length === exercise.words.length) {
                                    setTimeout(() => onAnswer(currentSentence.join(' ')), 600);
                                }
                            }
                        }, [word]);
                        poolContainer.appendChild(wordBtn);
                    });
                };

                renderState();
                container.appendChild(sentenceContainer);
                container.appendChild(poolContainer);
                return container;
            },

            flashcards: (exercise, onAnswer) => {
                const container = el('div', { className: "flex flex-col items-center w-full" });
                let flipped = false;

                const cardInner = el('div', { className: "w-full h-full duration-500 transform-style-3d relative transition-transform" });
                const cardContainer = el('div', { 
                    className: "w-full h-[250px] relative perspective-1000 cursor-pointer group",
                    onClick: () => {
                        flipped = !flipped;
                        cardInner.className = `w-full h-full duration-500 transform-style-3d relative transition-transform ${flipped ? 'rotate-y-180' : ''}`;
                    }
                }, [cardInner]);

                const front = el('div', { className: "absolute w-full h-full backface-hidden bg-vox-dark text-white rounded-3xl flex items-center justify-center text-3xl font-bold shadow-xl p-4 text-center" }, [exercise.front]);
                const back = el('div', { className: "absolute w-full h-full backface-hidden bg-primary text-white rounded-3xl flex items-center justify-center text-3xl font-bold shadow-xl rotate-y-180 p-4 text-center" }, [exercise.back]);

                cardInner.appendChild(front);
                cardInner.appendChild(back);

                const btn = el('button', {
                    className: "w-full mt-8 py-4 px-5 bg-white border border-gray-200 rounded-xl text-lg font-semibold text-vox-dark hover:border-primary hover:bg-cyan-50 hover:text-primary-hover transition-all shadow-sm",
                    onClick: () => onAnswer(exercise.answer || exercise.back)
                }, ["I've memorized this"]);

                container.appendChild(cardContainer);
                container.appendChild(btn);
                return container;
            },

            fill_blank_typing: (exercise, onAnswer) => {
                const parts = exercise.question.split('___');
                let value = '';
                
                const input = el('input', {
                    type: "text",
                    className: "border-none border-b-2 border-primary outline-none w-[140px] text-center text-xl font-inherit mx-2 bg-transparent focus:border-primary-hover",
                    onInput: (e) => { value = e.target.value; }
                });

                const container = el('div', {}, [
                    el('h3', { className: "text-xl font-semibold mb-6 text-vox-dark" }, ["Type the missing word:"]),
                    el('div', { className: "text-xl leading-loose mb-8" }, [
                        parts[0],
                        input,
                        parts[1]
                    ]),
                    el('button', {
                        className: "w-full py-4 bg-vox-dark text-white rounded-xl font-semibold hover:bg-gray-800 transition-colors",
                        onClick: () => onAnswer(value)
                    }, ["Check Answer"])
                ]);
                return container;
            },

            tap_fill: (exercise, onAnswer) => {
                const parts = exercise.question.split('___');
                let filledWord = null;

                const blankSpan = el('span', { className: "text-primary border-b-[3px] border-primary px-3 font-bold" }, ["..."]);
                const questionDisplay = el('div', { className: "text-2xl my-8 p-8 bg-slate-50 rounded-xl text-center border border-gray-100" }, [
                    parts[0], blankSpan, parts[1]
                ]);

                const optionsContainer = el('div', { className: "flex gap-3 flex-wrap justify-center" });
                exercise.options?.forEach(opt => {
                    const btn = el('button', {
                        className: "px-6 py-4 bg-white border border-gray-200 rounded-xl font-semibold hover:border-primary hover:bg-cyan-50 hover:text-primary-hover transition-all shadow-sm",
                        onClick: () => {
                            blankSpan.textContent = opt;
                            setTimeout(() => onAnswer(opt), 400);
                        }
                    }, [opt]);
                    optionsContainer.appendChild(btn);
                });

                return el('div', {}, [
                    el('h3', { className: "text-xl font-semibold mb-6 text-vox-dark" }, ["Complete the sequence:"]),
                    questionDisplay,
                    optionsContainer
                ]);
            },

            pronunciation: (exercise, onAnswer) => {
                const statusSpan = el('span', {}, ["Tap to Record"]);
                const btnContent = el('span', {}, ["ðŸŽ¤ ", statusSpan]);
                let isRecording = false;

                const btn = el('button', {
                    className: "w-full py-5 rounded-xl text-white font-bold text-lg transition-all shadow-md bg-vox-dark hover:bg-gray-800",
                    onClick: async () => {
                        const lang = exercise.voiceLang || 'en-US';
                        statusSpan.textContent = `Recording (${lang})...`;
                        isRecording = true;
                        btn.className = "w-full py-5 rounded-xl text-white font-bold text-lg transition-all shadow-md bg-error animate-pulse";
                        btn.disabled = true;

                        try {
                            const res = await startListening(lang);
                            isRecording = false;
                            btn.disabled = false;
                            onAnswer(res);
                        } catch (e) {
                            console.error('Mic Error:', e);
                            isRecording = false;
                            btn.disabled = false;
                            btn.className = "w-full py-5 rounded-xl text-white font-bold text-lg transition-all shadow-md bg-vox-dark hover:bg-gray-800";
                            
                            const errMap = {
                                'no-speech': 'No speech detected',
                                'not-allowed': 'Mic access denied',
                                'audio-capture': 'No mic found',
                                'network': 'Network error',
                                'not-supported': 'Not supported',
                                'service-not-allowed': 'Service not allowed'
                            };
                            const msg = errMap[e] || (typeof e === 'string' ? e : 'Try Again');
                            statusSpan.textContent = msg;
                        }
                    }
                }, [btnContent]);

                return el('div', { className: "text-center" }, [
                    el('h3', { className: "text-xl font-semibold mb-4 text-vox-dark" }, ["Voice Articulation:"]),
                    el('p', { className: "text-4xl font-extrabold text-primary my-10" }, [exercise.question]),
                    btn
                ]);
            }
        };

        // --- Exercise Runner Controller ---
        class ExerciseRunner {
            constructor(container, params, siteLanguage, onComplete, onBack, onTranslationRequest) {
                this.container = container;
                this.params = params;
                this.siteLanguage = siteLanguage;
                this.onComplete = onComplete;
                this.onBack = onBack;
                this.onTranslationRequest = onTranslationRequest;
                
                this.data = null;
                this.currentIdx = 0;
                this.loading = true;
                this.error = false;
            }

            async init() {
                try {
                    this.renderLoading();
                    this.data = await fetchData(this.params.cid);
                    this.loading = false;
                    this.render();
                } catch (e) {
                    this.error = true;
                    this.loading = false;
                    this.render();
                }
            }

            renderLoading() {
                this.container.innerHTML = '';
                this.container.appendChild(el('div', { className: "text-center py-20" }, [
                    el('div', { className: "w-8 h-8 mx-auto border-4 border-gray-200 border-t-primary rounded-full animate-spin-custom" })
                ]));
            }

            renderError() {
                this.container.innerHTML = '';
                const backBtn = el('button', { className: "text-primary underline", onClick: this.onBack }, ["Go Back"]);
                this.container.appendChild(el('div', { className: "text-center py-20" }, ["Stage load error. ", backBtn]));
            }

            handleAnswer(input) {
                const ex = this.data.exercises[this.currentIdx];
                const solution = ex.type === 'matching' ? input : ex.answer;
                
                const norm = (s) => String(s).toLowerCase().trim().replace(/[.,!?;]/g, '');
                const correct = !solution || norm(input) === norm(solution);

                showFeedbackOverlay(correct, () => {
                    if (correct) {
                        this.currentIdx++;
                        this.render();
                    }
                });
            }

            render() {
                if (this.loading) { this.renderLoading(); return; }
                if (this.error || !this.data) { this.renderError(); return; }

                if (this.currentIdx >= this.data.exercises.length) {
                    this.container.innerHTML = '';
                    this.container.appendChild(el('div', { className: "text-center py-10" }, [
                        el('div', { className: "text-6xl mb-6" }, ["ðŸ†"]),
                        el('h2', { className: "text-3xl font-extrabold text-vox-dark mb-2" }, ["Mastery Achieved!"]),
                        el('p', { className: "text-secondary mb-8 text-lg" }, ["You have successfully completed this module."]),
                        el('button', {
                            className: "px-8 py-3 bg-vox-dark text-white rounded-xl font-bold hover:scale-105 transition-transform",
                            onClick: () => this.onComplete(this.params.level, this.params.section, this.params.stageId)
                        }, ["Next Module"])
                    ]));
                    return;
                }

                const ex = this.data.exercises[this.currentIdx];
                const progress = (this.currentIdx / this.data.exercises.length) * 100;

                this.container.innerHTML = '';
                
                // Top Bar
                const topBar = el('div', { className: "flex justify-between items-center mb-2" }, [
                    el('span', { className: "text-xs font-bold text-secondary uppercase tracking-wider" }, [`Exercise ${this.currentIdx + 1} / ${this.data.exercises.length}`]),
                    el('div', { className: "flex gap-2" }, [
                        this.currentIdx > 0 ? el('button', {
                            className: "bg-slate-100 text-secondary border border-gray-200 px-3 py-1 rounded-md text-xs font-bold uppercase hover:bg-gray-200 hover:text-vox-dark transition-colors",
                            onClick: () => { this.currentIdx--; this.render(); }
                        }, ["back"]) : null,
                        el('button', {
                            className: "bg-slate-100 text-secondary border border-gray-200 px-3 py-1 rounded-md text-xs font-bold uppercase hover:bg-gray-200 hover:text-vox-dark transition-colors",
                            onClick: () => { this.currentIdx++; this.render(); }
                        }, ["skip"])
                    ])
                ]);

                // Progress Bar
                const progressBar = el('div', { className: "w-full h-2 bg-gray-200 rounded-full mb-6 overflow-hidden" }, [
                    el('div', { className: "h-full bg-primary transition-all duration-300 ease-out", style: { width: `${progress}%` } })
                ]);

                // Exercise Content
                let exerciseContent;
                if (ExerciseRenderers[ex.type]) {
                    exerciseContent = ExerciseRenderers[ex.type](ex, this.handleAnswer.bind(this), showFeedbackOverlay);
                } else {
                    exerciseContent = el('div', {}, ["Unknown exercise type"]);
                }

                this.container.appendChild(topBar);
                this.container.appendChild(progressBar);
                this.container.appendChild(exerciseContent);

                // Deep Analysis Floating Button
                const deepBtn = el('div', { className: "fixed bottom-8 right-8 z-[1500]" }, [
                    el('button', {
                        className: "px-6 py-3 bg-vox-dark text-white rounded-full font-semibold shadow-vox-lg hover:scale-105 transition-transform",
                        onClick: () => this.onTranslationRequest(ex.id, this.siteLanguage)
                    }, ["ðŸŒ Deep Analysis"])
                ]);
                this.container.appendChild(deepBtn);
            }
        }

        /**
         * ------------------------------------------------------------------
         * MAIN APP
         * ------------------------------------------------------------------
         */

        const root = document.getElementById('root');
        let userState = initSession();
        let manifest = null;
        let view = 'menu';
        let activeStage = null;
        
        // Translation Modal State
        let transModalOpen = false;
        let transExId = null;
        let activeModalEl = null;

        function updateState(key, value) {
            userState[key] = value;
            saveProgress(userState);
            renderApp();
        }

        function handleSelectStage(cid, level, section, stageId) {
            activeStage = { cid, level, section, stageId };
            view = 'exercise';
            transModalOpen = false;
            renderApp();
        }

        function handleStageComplete(level, section, stageId) {
            userState = unlockStage(userState, 'all', level, section, stageId + 1);
            view = 'menu';
            activeStage = null;
            renderApp();
        }

        function toggleTransModal(isOpen, exId) {
            transModalOpen = isOpen;
            transExId = exId || null;
            if (activeModalEl) activeModalEl.remove();
            
            // Re-render modal only
            activeModalEl = createTranslationModal(transModalOpen, transExId, userState.siteLanguage, () => toggleTransModal(false));
            document.body.appendChild(activeModalEl);
        }

        async function initApp() {
            try {
                manifest = await fetchData('manifest.json');
            } catch (e) {
                console.error("Failed to load manifest", e);
            }
            renderApp();
        }

        function renderApp() {
            root.innerHTML = '';
            
            // Header
            root.appendChild(createHeader(userState, updateState, () => window.location.reload()));

            // Main Container
            const mainContainer = el('div', { className: "w-[95%] max-w-[1100px] mx-auto mt-10 p-6 md:p-10 bg-card-bg rounded-3xl shadow-vox-lg border border-gray-200 min-h-[500px] transition-all duration-300" });
            
            if (view === 'menu') {
                mainContainer.appendChild(createStageMenu(manifest, userState, handleSelectStage));
            } else if (view === 'exercise' && activeStage) {
                // Initialize Exercise Runner
                const runner = new ExerciseRunner(
                    mainContainer, 
                    activeStage, 
                    userState.siteLanguage,
                    handleStageComplete,
                    () => { view = 'menu'; renderApp(); },
                    (exId, lang) => toggleTransModal(true, exId)
                );
                runner.init();
            }

            root.appendChild(mainContainer);

            // Re-mount modal if open
            if(transModalOpen && !activeModalEl?.parentNode) {
                 activeModalEl = createTranslationModal(transModalOpen, transExId, userState.siteLanguage, () => toggleTransModal(false));
                 document.body.appendChild(activeModalEl);
            }
        }

        // Start
        initApp();

    </script>
</body>
</html>